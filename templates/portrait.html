<!-- templates/portrait.html  (ÂèØÁÇπÂáªËÑëÂå∫Ê±áÊÄªÈ°µÈù¢ / Portrait) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NeuroView ‚Äì Portrait</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* ================= Âü∫Êú¨Â∏ÉÂ±Ä / Base layout ================ */
    body { margin: 0; font-family: "Segoe UI", sans-serif; background: #ffffff; }
    .topbar { display:flex; align-items:center; justify-content:space-between; padding:16px 30px; border-bottom:1px solid #e0e0e0; }
    .logo { font-size:22px; font-weight:bold; color:#2c3e50; }
    .nav-links { display:flex; gap:16px; }
    .nav-link { text-decoration:none; color:#2c5eff; font-weight:500; padding:6px 12px; border-radius:6px; }
    .nav-link:hover { background:#eef3ff; }

    h2 { text-align:center; margin:30px 0 10px; color:#2c3e50; }
    p.subtitle { text-align:center; color:#666; margin-bottom:30px; }

    /* ================= ËÑëÂõæ‰∏éÊ∞îÊ≥° / Brain figure & bubbles ================ */
    .brain-wrapper {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }
    .brain-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      pointer-events: none;
      z-index: 1;
    }
    .region {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      opacity: 0.3; /* faint visible */
      cursor: pointer;
      transition: opacity 0.3s ease, filter 0.3s ease;
      z-index: 2;
    }
    .region.hovered {
      opacity: 1; /* highlight on hover */
      filter: drop-shadow(0 0 6px #ffc107);
    }
    .region.selected {
      opacity: 1; /* lock highlight on click */
      filter: drop-shadow(0 0 8px #ff5722);
    }



    /* ÁÇπÂáªÂå∫ÂüüÂÆπÂô® / Region wrapper */
    .region { position:absolute; width:60px; height:60px; cursor:pointer; }
    /* Â∞èÊ∞îÊ≥° / Bubble label */
    .region .bubble { position:absolute; top:0; left:70px; white-space:nowrap; padding:4px 10px; background:#eaf2ff; color:#2c5eff; font-size:13px; border-radius:16px; box-shadow:0 0 0 2px #ffffff; transition:all .2s; }
    /* ÊÇ¨ÊµÆ/ÊøÄÊ¥ªÊïàÊûú / Hover & active */
    .region.active .bubble, .region:hover .bubble { background:#ffc23c; color:#333; filter:drop-shadow(0 0 6px #ffc23c); }

    /* ================= Tooltip ÊÇ¨ÊµÆÁ™ó ================= */
    #tooltip { position:fixed; z-index:9999; background:#ffffff; border:1px solid #ddd; border-radius:8px; padding:10px 14px; box-shadow:0 2px 8px rgba(0,0,0,.1); font-size:13px; color:#333; pointer-events:none; display:none; max-width:240px; }

    /* ================= ÁªìÊûúÈù¢Êùø / Result panel ================ */
    #results-panel { max-width:1100px; margin:40px auto; padding:20px 30px; border:1px solid #ddd; border-radius:12px; background:#fafbfd; display:none; }
    #summary-box { display:flex; flex-wrap:wrap; gap:24px; margin-bottom:20px; font-weight:bold; color:#2c3e50; }
    #study-list { display:flex; flex-direction:column; gap:12px; max-height:500px; overflow-y:auto; }
    .study-item { border-bottom:1px solid #e0e0e0; padding:10px 0; display:flex; justify-content:space-between; align-items:center; }
    .study-item a.title { color:#2c5eff; text-decoration:none; }
    .study-item .meta { font-size:12px; color:#666; margin-top:4px; }
    .dataset-link { font-size:12px; color:#2c5eff; text-decoration:none; }
  </style>
</head>

<body>
  <!-- È°∂ÈÉ®ÂØºËà™ / Top navigation -->
  <div class="topbar">
    <div class="logo">üß† NeuroView</div>
    <div class="nav-links">
      <a class="nav-link" href="/">Home</a>
      <a class="nav-link" href="/studies">Studies</a>
      <a class="nav-link" href="/viewer">Data Viewer</a>
      <a class="nav-link" href="/help">Help</a>
    </div>
  </div>

  <h2>Anatomical Portrait</h2>
  <p class="subtitle">Hover or click a brain region to explore related studies</p>

  <!-- ËÑëÂõæÂÆπÂô® / Brain figure container -->
  <div class="brain-wrapper" id="brainWrapper">
    <img id="brain_base" src="/static/img/brain_base.png" class="brain-layer" />
  
    <!-- Transparent region image layer -->
    <img src="/static/img/brain_1_cerebral_cortex.png" class="region" data-region="cerebral cortex">
    <img src="/static/img/brain_2_temporal lobe.png" class="region" data-region="temporal lobe">
    <img src="/static/img/brain_3_thalamus.png" class="region" data-region="thalamus">
    <img src="/static/img/brain_5_cerebellum.png" class="region" data-region="cerebellum">
    <img src="/static/img/brain_6_cerebral_nuclei.png" class="region" data-region="cerebral nuclei">
    <img src="/static/img/brain_4_7_brainstem.png" class="region" data-region="brainstem">
    <img src="/static/img/brain_8_spinal_cord.png" class="region" data-region="spinal cord">
  </div>


  <!-- ‰ø°ÊÅØÊÇ¨ÊµÆÁ™ó / Tooltip -->
  <div id="tooltip"></div>

  <!-- ÁªìÊûúÈù¢Êùø / Result panel -->
  <div id="results-panel">
    <div id="summary-box"></div>
    <div id="study-list"></div>
  </div>

  <!-- Êï∞ÊçÆ‰∏éËÑöÊú¨ / Data & scripts -->
  <script src="/static/js/studies_data.js"></script>
  <script>
    (function () {
      /* ---------- Â∑•ÂÖ∑ÂáΩÊï∞ / Helper functions ---------- */
      const toNumber = (x) => {
        const n = parseFloat(String(x).replace(/[^\d.]/g, ""));
        return isNaN(n) ? 0 : n;
      };
      // Ê†πÊçÆÂå∫ÂüüÁ≠õÈÄâÁ†îÁ©∂ / Filter studies by region
      function filterStudies(region) {
        const fields = ["Region1","Region2","Region3","Subregion1","Subregion2","Subregion3"];
        return allStudies.filter(s => fields.some(k => (s[k]||"").toLowerCase().includes(region.toLowerCase())));
      }

      /* ---------- Ê∏≤ÊüìÁªìÊûú / Render results ---------- */
      function renderResults(regionName) {
        const studies = filterStudies(regionName);
        const totalSamples = studies.reduce((a,s)=>a+toNumber(s["Sample number"]),0);
        const totalCells   = studies.reduce((a,s)=>a+toNumber(s["Cell number"]),0);
        const datasetCount = new Set(studies.map(s => s["Dataset Link"]).filter(Boolean)).size;

        document.getElementById("summary-box").innerHTML = `
          <div>Articles: <span style="color:#2c5eff">${studies.length}</span></div>
          <div>Datasets: <span style="color:#2c5eff">${datasetCount}</span></div>
          <div>Samples: <span style="color:#2c5eff">${totalSamples}+ </span></div>
          <div>Cells: <span style="color:#2c5eff">${totalCells}+ </span></div>`;

        document.getElementById("study-list").innerHTML = studies.map(s => `
          <div class="study-item">
            <div>
              <a class="title" href="${s["DOI/Publication Link"]}" target="_blank">${s["Publication title"]}</a>
              <div class="meta">${(s["Journal"]||"") + (s["Year of Publication"]? ` ¬∑ ${s["Year of Publication"]}`:"")}</div>
            </div>
            <div><a class="dataset-link" href="${s["Dataset Link"]}" target="_blank">Dataset</a></div>
          </div>`).join("");

        const panel = document.getElementById("results-panel");
        panel.style.display = "block";
        panel.scrollIntoView({behavior:"smooth"});
      }

      const regions = document.querySelectorAll('.region');
      let selectedRegion = null;

      regions.forEach(region => {

        // highlight the region that is hovered and dim others
        region.addEventListener('mouseenter', () => {
          if (!region.classList.contains('selected')) {
            region.classList.add('hovered');
            regions.forEach(other => {
              if (other !== region && !other.classList.contains('selected')) {
                other.style.opacity = '0.1';
              }
            });
          }
        });

        // remove highlight when mouse leaves the region
        region.addEventListener('mouseleave', () => {
          if (!region.classList.contains('selected')) {
            region.classList.remove('hovered');
            regions.forEach(other => {
              if (!other.classList.contains('selected')) {
                other.style.opacity = '0.3';
              }
            });
          }
        });

        // show results when the region is clicked
        region.addEventListener('click', () => {
          if (selectedRegion) {
            selectedRegion.classList.remove('selected');
            selectedRegion.classList.remove('hovered');
          }
          region.classList.add('selected');
          selectedRegion = region;

          const name = region.getAttribute('data-region');
          renderResults(name);

          regions.forEach(other => {
            if (!other.classList.contains('selected')) {
              other.classList.remove('hovered');
              other.style.opacity = '0.3';
            }
          });
        });
      });

    })();
  </script>
</body>
</html>
